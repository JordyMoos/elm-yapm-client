<!DOCTYPE html>
<html lang="en" manifest="manifest.appcache">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Passwords</title>
    <link rel="icon" type="image/png" href="img/favicon.png" />

    <!-- build:js js/manager.min.js -->
    <script src="js/manager.js" type="application/javascript;version=1.8"></script>
    <!-- /build -->
    <!-- build:js js/elm.min.js -->
    <script src="js/elm.js" type="application/javascript"></script>
    <!-- /build -->
    <!-- build:js js/clipboard.min.js -->
    <script src="js/clipboard.js" type="application/javascript"></script>
    <!-- /build -->

    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <link rel="stylesheet" type="text/css" href="css/yapm.css" />

</head>

<body>
    <script>

      function getErrorMessage(error) {
        console.log('In catch');
        console.log(error);

        if (typeof(error) === 'string') {
          return error;
        }

        if (typeof(error) === 'object') {
          if (error.message && typeof(error.message) === 'string') {
            return error.message;
          }
        }

        return 'Unknown error';
      }

      var app = Elm.Main.fullscreen(window.yapm.config);
      app.ports.login.subscribe(function (request) {
        let { masterKey, library } = request;
        window.yapm.decryptLibrary(masterKey, library)
          .then(function (passwords) {
            app.ports.loginSuccess.send({
              library: {
                hmac: library.hmac,
                library: library.library
              },
              masterKey: masterKey,
              passwords: passwords
            });
          })
          .catch(function (error) {
            console.log("error message: " + getErrorMessage(error));

            app.ports.notification.send({
              level: "error",
              message: getErrorMessage(error),
            });
          });
      });

      app.ports.encryptLibrary.subscribe(function (request) {
        window.yapm.encryptLibrary(request)
          .then(function (data) {
            let [ oldHash, library, newHash ] = data;
            let response = {
              oldHash: oldHash,
              newHash: newHash,
              library: {
                hmac: library.hmac,
                library: library.library
              }
            };
            app.ports.encryptLibrarySuccess.send(response);
          })
          .catch(function (error) {
            app.ports.notification.send({
              level: "error",
              message: getErrorMessage(error),
            });
          });
      });

      var clipboard = new Clipboard('.copyable');
    </script>
</body>

</html>
